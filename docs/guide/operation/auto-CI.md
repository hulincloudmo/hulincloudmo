# 自动化部署

## 1.我们为什么要使用自动化部署？

 * **烦恼：**
在我开发项目时，常常会因为产品需要测试线上环境，所以我们需要暂时部署一个未开发完善的版本，又或者是在版本更新的时候我们都需要对线上环境进行一次部署，因为本人不是专业的运维人员，部署的知识往往会忘记一些细节，往往部署的时候都需要去百度解决方案，而且就算在熟练的情况下，数据的迁移也是一个很大的工作量，在开发阶段，版本的迭代更是非常频繁，我们不可能每次版本更新都人工去操作线上环境，这样不仅容易造成线上环境变化，造成线上崩溃（本人亲身经历。。操作失误，绝望的重装了线上环境，浪费了半天时间），而且人工部署也是不可重复且不可靠的部署工作模式

## 所以，使用自动化部署是一个减少996，提高生产效率的必备手段！

* **好处：**
部署过程的每一个步骤都自动化，可以带来包括效能在内的显著的好处。你可以手工做这些事情，但是很耗时。二者的生产率差异真的很大。一般目前部署过程涉及到应用、环境和部署流程主要的模型。要实现自动化首先要做的是将需要部署的应用、环境和流程进行建模，所以还是需要一个自动化部署系统来支撑。（引用百度百科）

## 什么是持续集成（CI）/持续部署（CD）？

谈到自动部署，我们自然要学到两个非常重要的计算机概念，<font face="微软雅黑" color="red" size=5>持续集成、持续部署</font>
* **基本概念**
工厂里的装配线以快速、自动化、可重复的方式从原材料生产出消费品。同样，软件交付管道以快速、自动化和可重复的方式从源代码生成发布版本。<font face="微软雅黑" color="red">如何完成这项工作的总体设计称为“持续交付”（CD）。启动装配线的过程称为“持续集成”（CI）。确保质量的过程称为“持续测试”，将最终产品提供给用户的过程称为“持续部署”。</font>
一些专家让这一切简单、顺畅、高效地运行，这些人被称为 运维开发(DevOps)践行者。

* **持续**，在语文上的意思是延续，继续；无间隔，连续不断。可是，在计算机中，持续是指“随时可运行”，在软件开发领域，它还有几个核心概念：

**频繁发布**：在我们真实的工作中，业务需求变化可能十分迅速，我们程序员可能需要频繁的，高效的交出高质量的代码（996） 有些业务变化频繁的企业甚至几天就需要交付一次产品变更，在我大学的研发中，由于没有专业的产品业务设计，需求有时候几天就需要变化一次。在我们完成了复杂的产品开发后，还要操心业务部署问题，代码测试问题，整个人都不好了。

**快速迭代**：版本在开发完成后，应该尽快的，通过各类测试用例，尽快交付生产环境使用

## DevOps自动上线

在我们开发者推送代码到服务器后，服务器会产生一个[Webhook](webhook.md)请求CI所在的服务，触发开发者事前写好的处理逻辑脚本，如拉取代码，代码分析，打包，部署，等等操作，最后推送到服务集群


## 自动化部署实践--使用TravisCI自动化部署Vuepress
大家看到的这篇文章网页，实际上就是使用了自动化部署的，在我没有学会自动化部署时，每次写了博客，还要花大量的时间去解决部署问题，懒癌患者感到压力山大，写博客的动力也就没了，于是，我也就开始研究如何自动化部署

### 思考：怎么才能实现自动部署
要实现自动化部署，我把他分为以下几个步骤
* 代码、文章编写
* 上传github
* CI监听到github文件变动，开始构建最新变化与代码测试
* CI构建完毕，将构建好的生产代码推送到生产环境/分支中
* 成功自动部署

### 为了实现文件监听，我们就必须使用CI工具

CI工具可以让我们实现监听构建的需求，介绍几款有名的CI工具：
* **Jenkins**
<font color="red">免费！</font>插件丰富，基本能够实现所有开发需求，但是也存在着比较大的学习成本和服务器需求，如果你的项目足够大，服务器性能有剩余，也需要部署构建工具到自己的服务器，那么你可以考虑

* **Travis CI**
比较老牌的CI工具，从开源项目发展到现在的闭源项目，他对开源软件是<font color="red">免费！</font>的，但是对商业应用是收费的，价格在69刀到489刀，如果你的代码是开源的，那么Travis是一个不错的选择

* **Circle CI**
Circle CI 是一个基于 云 的工具，可自动执行集成和部署过程。它还侧重于在部署之前测试代码的每个更改，使用多种方法，如 单元测试 ，集成测试和功能测试。该工具支持容器，OSX，Linux，可以在私有云或您自己的 数据 中心内运行。

* **TeamCity**
来自jetbrains公司的作品，jetbrains这家公司我必须给满分，对学生，开源的支持度是最好的，java开发工具更是一绝。jetbrains牛！这款CI工具，还是<font color="red">免费！</font>，如果你想用专业的CI又不想付费，那么TeamCity将会是一个不错的选择

* **GitLab**
GitLab CI作为GitLab的一部分免费提供，并且可以相当快速地设置。要开始使用GitLab CI，首先需要将. git lab-ci.yml文件添加到存储库的根目录，以及配置GitLab项目以使用Runner。之后，每次提交或推送都将触发具有三个阶段的CI管道：构建，测试和部署。

### 使用Travis自动化部署
因为本博客是开源的，我也就选用了Travis作为CI工具。

#### 部署过程：
1.要使用travis肯定要先注册的呢，在官网注册一个账号
2.编写自动化脚本，这里每个人的都不同，我展示一下我的配置，可供参照
```shell script
#!/usr/bin/env sh
​
# abort on errors
set -e
​
# build
npm run docs:build
​
# navigate into the build output directory
cd docs/.vuepress/dist
​
# if you are deploying to a custom domain
# echo 'www.example.com' > CNAME
​
git init
git add -A
git commit -m 'deploy'
​
# if you are deploying to https://<USERNAME>.github.io
# git push -f git@github.com:<USERNAME>/<USERNAME>.github.io.git master
​
# if you are deploying to https://<USERNAME>.github.io/<REPO>
 git push -f https://${access_token}@github.com/<USERNAME>/<USERNAME>.github.io.git master
​
cd -

```
在脚本中我们看到需要配置access_token，这个信息需要在github上配置，并且给这个access_token推送等权限，这样travis才能自动的推送编译好的代码到github容器中

* 因为项目不是配在根目录下，需要在vuepress的config中配置base路径： 例： “base: "/vuepress.github.io/"”

* 所有静态路径也需要写上这个子路径，不然会找不到图片





